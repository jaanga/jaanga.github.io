
<!DOCTYPE html>
<html lang="en">
	<head>
		<title>xg - earth bathymetry</title>

		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<style>
		    body {
				color: #fff;
				font-family:Monospace;
				font-size:13px;
				font-weight: bold;

				background-color: #000;
				margin: 0px;
				padding: 0px;
				line-height: 1.5em;
		    }

		    #info {
				text-align:center;
				color:#fff;
				position: absolute;
				top: 0px; width: 100%;

				padding: 5px 0px;
				z-index: 100;
		    }

			#help {
				color:#eee;
			}

		    a { color: white; }

			#stats { position: absolute; top:0; left: 0 }
			#stats #fps { background: transparent !important }
			#stats #fps #fpsText { color: #aaa !important }
			#stats #fps #fpsGraph { display: none }

			#loading { background: #0af; color: white; padding: 0.25em 1em; position: absolute; right:0px; top: 0px; z-index: 200; }
		</style>
	</head>

	<body>
		<div id="loading">Loading ...</div>

		<div id="info">
			<a href="http://alteredqualia.com/" target="_blank">xg</a> - earth bathymetry -
			data from nasa <a href="http://visibleearth.nasa.gov/view_cat.php?categoryID=1484">blue marble</a> (elevation not to scale)
			<div id="help">
			<span class="key">Z:</span> zoom,
			<span class="key">W:</span> water,
			<span class="key">R:</span> rotation,
			<span class="key">U:</span> ultra,
			<span class="key">P:</span> photo
			</div>
		</div>

		<script src="js/xg.min.eb.js"></script>
		<script src='js/libs/stats.min.js'></script>

		<script>

			var hasWebGL1 = Detector.webgl;
			var hasWebGL2 = Detector.webgl2;

			var loadingElement = document.getElementById( "loading" );
			var infoElement = document.getElementById( "info" );

			var hudVisible = true;
			var useDeferred = true;

			if ( ! ( hasWebGL1 || hasWebGL2 ) ) {

				loadingElement.style.display = "none";
				infoElement.style.display = "none";

				Detector.addGetWebGLMessage();

			} else {

			var backend = hasWebGL2 ? "webgl2" : "webgl1";

			var isMobile = Detector.isMobile;

			if ( ! Detector.deferredCapable || isMobile ) useDeferred = false;

			var useMRT = true;

			// platform-specific compatibility fixes
			// (mostly things that are supposed to work but are broken anyways)

			var isChrome   = navigator.userAgent.toLowerCase().indexOf( "chrome" ) >= 0;
			var isSafari   = navigator.userAgent.toLowerCase().indexOf( "safari" ) >= 0 && !isChrome;
			var isFirefox  = navigator.userAgent.toLowerCase().indexOf( "firefox" ) >= 0;
			var isExplorer = navigator.userAgent.toLowerCase().indexOf( "trident" ) >= 0;
			var isOSX 	   = navigator.platform.toLowerCase().indexOf( "mac" ) >= 0;

			// Firefox on OSX fails with multiple-render-targets

			if ( isOSX && isFirefox ) useMRT = false;

			//

			var SCALE = 1.0 / window.devicePixelRatio;
			var MARGIN = 0;
			var BRIGHTNESS = 2;

			var SCREEN_WIDTH = window.innerWidth;
			var SCREEN_HEIGHT = window.innerHeight - 2 * MARGIN;

			var isUltra = false;
			var ULTRA_THRESHOLD = 4000;

			var isPhoto = false;

			//

			var rotationEnabled = true;

			var container, camera, scene;
			var innerRenderer;
			var renderer;

			var dirLight, hemiLight, dayLight;
			var meshRoot;

			var earthMaterial;
			var normalMapWater;

			var assets = {};
			var planets = [];
			var spheres = [];
			var currentLOD = 0;

			var fovIndex = 0;
			var fovArray = [ 17.5, 10, 17.5, 30 ];

			var waterIndex = 0;
			var waterArray = [];

			// ui

			var loadCounter = 0;

			// camera controls

			var mouseX = 0;
			var mouseY = 0;

			var targetX = 0.0;
			var targetY = 0.0;
			var angle = 0.0;
			var height = 0.0;
			var target = new XG.Vector3();

			var windowHalfX = window.innerWidth / 2;
			var windowHalfY = window.innerHeight / 2;

			//

			var clock = new XG.Clock();

			function init() {

				// performance presets

				var gpuDetector = new GPUDetector();
				gpuData = gpuDetector.detectGPU();

				//

				if ( gpuData && gpuData.rawScore >= ULTRA_THRESHOLD ) {

					SCALE = 1.0;
					currentLOD = 3;
					isUltra = true;

				} else {

					SCALE = 0.7 / window.devicePixelRatio;
					currentLOD = 2;
					isUltra = false;

				}

				var pars = {

					"width"		: SCREEN_WIDTH,
					"height"	: SCREEN_HEIGHT,
					"scale"		: SCALE,
					"antialias"	: true,
					"tonemapping": XG.PhotographicOperator,
					"brightness": BRIGHTNESS,
					"clearColor": 0x020202,
					"clearAlpha": 1.0,
					"dither" 	: true,
					"alpha"		: false,
					"useMultipleRenderTargets": useMRT,
					"backend"	: backend

				};

				var shadowMapN = 2;

				if ( isMobile ) {

					pars[ "antialias" ] = false;
					pars[ "devicePixelRatio" ] = 0.7;

					currentLOD = 1;
					shadowMapN = 1;

				}

				//

				container = document.createElement( 'div' );
				document.body.appendChild( container );

				// camera

				camera = new XG.PerspectiveCamera( 17.5, SCREEN_WIDTH / SCREEN_HEIGHT, 50, 1500 );
				camera.position.set( 0, 0, 200 );

				// scene

				scene = new XG.Scene();
				scene.add( camera );

				// lights

				dayLight = new XG.DayLight( 0xffffff );
				dayLight.position.set( 0, 0.5, 1 ).multiplyScalar( 500 );
				scene.add( dayLight );

				dayLight.sunIntensity = 1.5;

				dayLight.castShadow = true;
				dayLight.shadowDarkness = 1;

				dayLight.shadowMapWidth  = 1024 * shadowMapN;
				dayLight.shadowMapHeight = 1024 * shadowMapN;
				dayLight.shadowCameraNear = 5;
				dayLight.shadowCameraFar = 1500;

				var d = 75;
				dayLight.shadowCameraLeft = -d;
				dayLight.shadowCameraRight = d;
				dayLight.shadowCameraTop = d;
				dayLight.shadowCameraBottom = -d;

				dayLight.hemiIntensity = 0.5;
				dayLight.groundColor.setHSV( 0, 0, 0.5 );
				dayLight.skyColor.setHSV( 0, 0, 1 );

				// renderer

				if ( useDeferred ) {

					renderer = new XG.DeferredRenderer( pars );

				} else {

					renderer = new XG.ForwardRenderer( pars );

				}


				renderer.domElement.style.position = "absolute";
				renderer.domElement.style.top = MARGIN + "px";
				container.appendChild( renderer.domElement );

				//

				renderer.shadowMapEnabled = true;
				renderer.shadowMapSlopeDepthBias = true;
				renderer.shadowMapCullFace = XG.CullFaceNone;
				renderer.shadowMapType = XG.PCFSoftShadowMap;

				if ( ! ( isMobile || isOSX ) ) renderer.shadowMapUseDepthTextures = true;

				//renderer.shadowMapDebug = true;

				//

				innerRenderer = renderer;

				if ( renderer instanceof XG.DeferredRenderer ) {

					innerRenderer = renderer.renderer;
					renderer.ssaoEnabled = true;

				}

				// stats

				stats = new Stats();
				container.appendChild( stats.domElement );

				// events

				window.addEventListener( 'resize', onWindowResize, false );
				document.addEventListener( 'mousemove', onDocumentMouseMove, false );
				document.addEventListener( 'keydown', onKeyDown, false );

				renderer.domElement.addEventListener( 'touchmove', onTouchMove, false );

				// content

				meshRoot = new XG.Node();
				meshRoot.rotation.y = -1.9;
				scene.add( meshRoot );

				var geo128 = new XG.SphereGeometry( 50, 128, 64 );
				var geo256 = new XG.SphereGeometry( 50, 256, 128 );
				var geo512 = new XG.SphereGeometry( 50, 512, 256 );
				var geo1024 = new XG.SphereGeometry( 50, 1024, 512 );
				var geo2048 = new XG.SphereGeometry( 50, 2048, 1024 );

				spheres[ 0 ] = geo128;
				spheres[ 1 ] = geo256;
				spheres[ 2 ] = geo512;
				spheres[ 3 ] = geo1024;
				spheres[ 4 ] = geo2048;

				if ( isMobile ) {

					var glossMap = XG.ImageUtils.loadTexture( "textures/earth-bathymetry/bathymetry_gloss_2k.jpg", checkLoaded );
					var bumpMap = XG.ImageUtils.loadTexture( "textures/earth-bathymetry/bathymetry_bw_composite_2k.jpg", checkLoaded );
					var diffuseMap = XG.ImageUtils.loadTexture( "textures/earth-bathymetry/bathymetry_diffuse_2k.jpg", checkLoaded );

				} else {

					var glossMap = XG.ImageUtils.loadTexture( "textures/earth-bathymetry/bathymetry_gloss_4k.jpg", checkLoaded );
					var bumpMap = XG.ImageUtils.loadTexture( "textures/earth-bathymetry/bathymetry_bw_composite_4k.jpg", checkLoaded );
					var diffuseMap = XG.ImageUtils.loadTexture( "textures/earth-bathymetry/bathymetry_diffuse_4k.jpg", checkLoaded );

				}
				normalMapWater = XG.ImageUtils.loadTexture( "textures/materials/water-normal.jpg", checkLoaded );

				normalMapWater.wrapS = normalMapWater.wrapT = XG.RepeatWrapping;
				glossMap.wrapS = glossMap.wrapT = XG.RepeatWrapping;
				bumpMap.wrapS = bumpMap.wrapT = XG.RepeatWrapping;
				diffuseMap.wrapS = diffuseMap.wrapT = XG.RepeatWrapping;

				glossMap.anisotropy = 16;
				bumpMap.anisotropy = 16;
				diffuseMap.anisotropy = 16;
				normalMapWater.anisotropy = 16;

				earthMaterial = new XG.PhongMaterial( {

					color: 0xffffff,
					map: diffuseMap,
					glossMap: glossMap,
					displacementMap: bumpMap,
					displacementScale: 10.0,
					shininess: 0.5

				} );

				if ( !isMobile ) {

					earthMaterial.bumpMap = bumpMap;
					earthMaterial.bumpScale = 0.5;

				}

				var geo = spheres[ currentLOD ];
				var planet = addPlanet( geo );
				planets[ currentLOD ] = planet;

				if ( isMobile ) {

					addWaterSimple();

				} else {

					addWaterFancy();

				}

			}

			// ------------------------------------------------------------

			function checkLoaded() {

				loadCounter += 1;

				if ( loadCounter >= 4 ) {

					loadingElement.style.display = "none";

				}

			}

			function onDocumentMouseMove ( event ) {

				mouseX = ( event.clientX - windowHalfX ) * 1;
				mouseY = ( event.clientY - windowHalfY ) * 1;

			}

			function onTouchMove( event ) {

				event.preventDefault();

				var touches = event.touches;
				var touch = touches[ 0 ];

				mouseX = ( touch.clientX - windowHalfX ) * 1;
				mouseY = ( touch.clientY - windowHalfY ) * 1;

			}

			function onKeyDown ( event ) {

				switch ( event.keyCode ) {

					case 49: /*1*/
						setLOD( 0 );
						break;

					case 50: /*2*/
						setLOD( 1 );
						break;

					case 51: /*2*/
						setLOD( 2 );
						break;

					case 52: /*3*/
						setLOD( 3 );
						break;

					case 53: /*4*/
						setLOD( 4 );
						break;

					case 90: /*Z*/
						if ( !event.ctrlKey ) toggleZoom();
						break;

					case 82: /*R*/
						if ( !event.ctrlKey ) toggleRotation();
						break;

					case 87: /*W*/
						if ( !event.ctrlKey ) toggleWater();
						break;

					case 85: /*U*/
						if ( !event.ctrlKey ) toggleUltra();
						break;

					case 80: /*P*/
						if ( !event.ctrlKey ) togglePhoto();
						break;

					case 72: /*H*/
						toggleHUD();
						break;

				}

			}

			function toggleRotation() {

				rotationEnabled = !rotationEnabled;

			}

			function toggleZoom() {

				fovIndex = ( fovIndex + 1 ) % fovArray.length;
				camera.fov = fovArray[ fovIndex ];
				camera.updateProjectionMatrix();

			}

			function toggleWater() {

				waterIndex = ( waterIndex + 1 ) % waterArray.length;
				scene.heightFog = waterArray[ waterIndex ];

			}

			// ------------------------------------------------------------

			function addWaterFancy() {

				var water1 = new XG.HeightFog( {

					"height"			   : 1,
					"visibilityDistance"   : 50.0,
					"fadeSpeed"			   : 0.5,
					"shallowDepthColor"    : new XG.Color().setRGB( 0.0078, 0.5176, 0.7 ),
					"deepDepthColor" 	   : new XG.Color().setRGB( 0.0039, 0.00196, 0.145 ),
					"rgbExtinctionDistance": new XG.Vector3( 7.0, 30.0, 40.0 ).multiplyScalar( 1 )

				} );

				var water2 = new XG.HeightFog( {

					"height"			   : 1,
					"visibilityDistance"   : 40.0,
					"fadeSpeed"			   : 0.8,
					"shallowDepthColor"    : new XG.Color().setRGB( 0.0078, 0.5176, 0.7 ),
					"deepDepthColor" 	   : new XG.Color().setRGB( 0.0039, 0.00196, 0.145 ),
					"rgbExtinctionDistance": new XG.Vector3( 7.0, 30.0, 40.0 ).multiplyScalar( 0.85 )

				} );

				var water3 = new XG.HeightFog( {

					"height"			   : 1,
					"visibilityDistance"   : 15.0,
					"fadeSpeed"			   : 1.0,
					"shallowDepthColor"    : new XG.Color().setRGB( 0.0078, 0.5176, 0.7 ),
					"deepDepthColor" 	   : new XG.Color().setRGB( 0.0039, 0.00196, 0.145 ),
					"rgbExtinctionDistance": new XG.Vector3( 7.0, 30.0, 40.0 ).multiplyScalar( 0.35 )

				} );

				var water4 = new XG.HeightFog( {

					"height"			   : 1,
					"visibilityDistance"   : 40.0,
					"fadeSpeed"			   : 0.8,
					"shallowDepthColor"    : new XG.Color().setRGB( 0.78, 0.5176, 0.07 ),
					"deepDepthColor" 	   : new XG.Color().setRGB( 0.39, 0.00196, 0.0145 ),
					"rgbExtinctionDistance": new XG.Vector3( 37.0, 20.0, 10.0 ).multiplyScalar( 0.85 )

				} );

				var water5 = new XG.HeightFog( {

					"height"			   : 1,
					"visibilityDistance"   : 60.0,
					"fadeSpeed"			   : 0.5,
					"shallowDepthColor"    : new XG.Color().setRGB( 0.78, 0.78, 0.78 ),
					"deepDepthColor" 	   : new XG.Color().setRGB( 0.39, 0.39, 0.39 ),
					"rgbExtinctionDistance": new XG.Vector3( 37.0, 37.0, 37.0 ).multiplyScalar( 0.85 )

				} );

				waterArray = [ water1, water2, water3, water4, water5 ];

				scene.heightFog = water1;

				// ------------------------------------------------------------

				var mm = 2;
				var WATER_OPACITY = 0.75;

				// ------------------------------------------------------------

				var waterGeo = new XG.SphereGeometry( 50, 256, 128 );

				var innerRenderer = renderer;
				if ( renderer instanceof XG.DeferredRenderer ) innerRenderer = renderer.renderer;

				waterSurface = new XG.WaterSurface( innerRenderer, {

					"clipBias"		: 0.0,
					"textureWidth"	: 1024,
					"textureHeight"	: 1024,
					"specular"		: 0x050505,
					"normalMap"		: normalMapWater,
					"normalScale"	: 3,
					"gloss"			: 0.85,
					"repeat"		: [ 2 * mm, mm ],
					"opacity"		: WATER_OPACITY

				} );

				var waterMaterial = waterSurface.material;

				waterMaterial.transparent = true;
				waterMaterial.defines[ "USE_REFLECTION" ] = false;
				waterMaterial.defines[ "WATER_SURFACE_SPHERE" ] = true;

				waterMaterial.uniforms[ "refractionScale" ].value = 0.0275;
				waterMaterial.uniforms[ "globalLightScale" ].value = 0.035;

				waterMaterial.isMirror = true;

				waterMesh = new XG.Mesh( waterGeo, waterMaterial );

				waterMesh.scale.multiplyScalar( 1.11 );
				waterMesh.receiveShadow = true;
				waterMesh.add( waterSurface );
				meshRoot.add( waterMesh );

				scene.properties.mirrors = [ waterSurface ];

			}

			// ------------------------------------------------------------

			function addWaterSimple() {

				normalMapWater.repeat.set( 2, 1 ).multiplyScalar( 4 );

				var geometry = new XG.SphereGeometry( 50, 128, 64 );

				var waterMaterial = new XG.PhongMaterial( {

					color: 0x000000,
					specular: 0x111111,
					normalMap: normalMapWater,
					shininess: 512,
					transparent: true,
					opacity: 0.6

				} );

				waterMaterial.color.setHSV( 0.51, 0.75, 0.25 );

				waterMesh = new XG.Mesh( geometry, waterMaterial );
				waterMesh.scale.multiplyScalar( 1.11 );
				waterMesh.receiveShadow = true;

				meshRoot.add( waterMesh );

			}

			// ------------------------------------------------------------

			function addPlanet( geometry ) {

				var mesh = new XG.Mesh( geometry, earthMaterial );
				mesh.castShadow = true;
				mesh.receiveShadow = true;

				meshRoot.add( mesh );

				return mesh;

			}

			function setLOD( lod ) {

				if ( planets[ lod ] === undefined ) {

					var geometry = spheres[ lod ];
					var planet = addPlanet( geometry );

					planets[ lod ] = planet;

				}

				planets[ currentLOD ].visible = false;
				planets[ lod ].visible = true;

				currentLOD = lod;

			}

			// ------------------------------------------------------------

			function togglePhoto() {

				if ( !isPhoto ) {

					setLOD( 4 );
					renderer.setScale( 2.0 );

					infoElement.style.display = "none";
					hudVisible = false;

					isPhoto = true;

				} else {

					if ( !isUltra ) {

						setLOD( 2 );
						renderer.setScale( 0.7 / window.devicePixelRatio );

					} else {

						setLOD( 3 );
						renderer.setScale( 1.0 );

					}

					infoElement.style.display = "block";
					hudVisible = true;

					isPhoto = false;

				}

			}

			function toggleUltra() {

				if ( !isUltra ) {

					setLOD( 3 );
					renderer.setScale( 1.0 );
					isUltra = true;

				} else {

					setLOD( 2 );
					renderer.setScale( 0.7 / window.devicePixelRatio );
					isUltra = false;

				}

			}

			function toggleHUD() {

				if ( hudVisible ) {

					infoElement.style.display = "none";
					hudVisible = false;

				} else {

					infoElement.style.display = "block";
					hudVisible = true;

				}

			}


			// ------------------------------------------------------------

			// event handlers

			function onWindowResize ( event ) {

				SCREEN_WIDTH = window.innerWidth;
				SCREEN_HEIGHT = window.innerHeight - 2 * MARGIN;

				renderer.setSize( SCREEN_WIDTH, SCREEN_HEIGHT );

				camera.aspect = SCREEN_WIDTH/ SCREEN_HEIGHT;
				camera.updateProjectionMatrix();

			}

			// updates

			function animate() {

				requestAnimationFrame( animate );
				render();

				stats.update();

			}

			function render() {

				var rawDelta = clock.getDelta();
				var delta = 0.125 * rawDelta;

				// update camera

				targetX = mouseX * 0.04;
				targetY = mouseY * 0.04;

				angle  += 0.05 * ( targetX - angle );
				height += 0.05 * ( targetY - height );

				var d = 380;
				var n = 0.075;

				var x =  -Math.sin( angle * n ) * d;
				var z =   Math.cos( angle * n ) * d;
				var y = 15.5 * height + 0;

				camera.position.set( x, y, z );
				camera.lookAt( target );

				// update objects

				if ( rotationEnabled ) {

					meshRoot.rotation.y += delta;

				}

				// render scene

				renderer.render( scene, camera );

			}

			//

			init();
			animate();

}
		</script>

	</body>
</html>
